%2021-1-27.
clear;
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%基本信息输入%%%%%%%%%%%%%%%%%%%%%%%%%
tic
J=18;%定义节点数量
N=34;%定义节点数量
%定义余支初始流量
global dQ;
global Qy;
Qy=[0.3164,0.1663,0.03289,0.2038,0.08528,0.13583,0.09259,0.11833,0.10981,0.120,0.25935,0.31907,0.00768,0.05864,0.06935,0.29222,0.17731];
%定于官网阻抗
global S;
S=[596.36,1722.57,2939.03,2443.41,5304.85,3955.60,3139.24,3020.87,21458.63,2759.70,14849.93,42235.18,20172.21,3899.41,2775.77,5364.15,11633.29,2113.72,1745147.19173,42456906.026784,1015675.98553464,5512726.8406,1969751.33426173,4010024.88,2371222.3765126,2692675.62917663,2035107.63888889,432827.025284615,285960.182825714,564145020.864,10291920.08,7475080.42516858,427611.938874351,1255460.8];%管网阻抗
%定义官网动力
global P
P=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,40000,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];
%定义独立回路矩阵
global Cf;
Cf=[1,1,1,1,1,1,1,1,1,1,1,-1,-1,-1,-1,-1,-1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0;
    1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0;
    1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0;
    1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0;
    1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0;
    1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0;
    1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0;
    1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0;
    1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0;
    1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0;
    1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0;
    1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0;
    0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0;
    0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0;
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0;
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0;
    0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1
    ];
%定义余支求数支方法
global A;
A=[-1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0;
   -1,0,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0;
   -1,0,0,1,1,1,1,1,1,1,1,1,0,0,0,0,0;
   -1,0,0,0,1,1,1,1,1,1,1,1,0,0,0,0,0;
   -1,0,0,0,0,1,1,1,1,1,1,1,0,0,0,0,0;
   -1,0,0,0,0,0,1,1,1,1,1,1,0,0,0,0,0;
   -1,0,0,0,0,0,0,1,1,1,1,1,0,0,0,0,0;
   -1,0,0,0,0,0,0,0,1,1,1,1,0,0,0,0,0;
   -1,0,0,0,0,0,0,0,0,1,1,1,0,0,0,0,0;
   -1,0,0,0,0,0,0,0,0,0,1,1,0,0,0,0,0;
   -1,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0;
   1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0;
   1,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0;
   1,0,0,0,0,0,0,0,0,0,0,0,1,1,0,0,0;
   1,0,0,0,0,0,0,0,0,0,0,0,1,1,1,0,0;
   1,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,0;
   1,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1;
   0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1;
   0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0;
   0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0;
   0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0;
   0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0;
   0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0;
   0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0;
   0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0;
   0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0;
   0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0;
   0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0;
   0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0;
   0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0;
   0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0;
   0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0;
   0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0;
   0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1];
Qq1=A*Qy';%利用余支计算所有分支流量
Qq2=square(Qq1);%计算Q|Q|矩阵
P1=zuli(Qq2,S);%计算SQ|Q|数组
P0=(P1-P);%计算S|Q|Q-P；
dp=-Cf*(P1-P)';%计算回路余压
n1=1;%记录迭代次数
n2=1;%记录下山因子迭代次数
x0=1;
dp0=max(abs(dp));
dpx=[];
nn2=[];
% while dp0>500&&n1<50 %闭合回路压力差精度要求
% %     dQ=serchJaco(A,S,Cf,Qy,dp);
% %     dpx(n1)=dp0;
% %     if n1==1
% %         Qy=Qy+dQ';
% %     end
% %     if (n1>1)&&(n1<20)
% %         Qy=Qy+(1/power(2,(n1-1)))*dQ';
% %     end
% %     if n1>=20
% %         Qy=Qy+(1/power(100,(n1-17)))*dQ';
% %     end
%     Qq1=A*Qy';
%     Qq2=square(Qq1);
%     P1=zuli(Qq2,S);
%     dp=-Cf*(P1-P)';
%     n1=n1+1;
%     dp0=max(abs(dp));
% end
dQ=serchJaco(A,S,Cf,Qy,dp);%计算△Q
while dp0>100&&n1<=50&&max(dQ)>0.005 %闭合回路压力差精度要求
    dpx(n1)=dp0;
    [X1,dp1]=ga(@fdp,17,[],[],[],[],-1/n1,1/n1);
%     if n1<=1
%       [X1,dp1]=ga(@fdp,17,[],[],[],[],0,1/n1);
%     end
%     if n1>1&&n1<5
%       [X1,dp1]=ga(@fdp,17,[],[],[],[],0,0.5);
%     end
%     if n1>=5&&n1<10
%       [X1,dp1]=ga(@fdp,17,[],[],[],[],0,0.25);
%     end
%     if n1>=10
%       [X1,dp1]=ga(@fdp,17,[],[],[],[],0,0.1);
%     end
     %牛顿下山计算新的余支流量
%     Qy1=Qy+x0*dQ';
%     Qq1=A*Qy1';
%     Qq2=square(Qq1);
%     P1=zuli(Qq2,S);
%     dp=-Cf*(P1-P)';
%     dp1=max(abs(dp));
%     n3=0;
%     while dp1>=dp0&&n3<200
%         if n2<20
%             x0=x0*0.5;
%         end
%         if n2>=20&&n2<50
%             x0=x0*0.01;
%         end
%         if n2>=50
%             x0=x0*0.001;
%         end
%         Qy1=Qy+x0*dQ';
%         Qq1=A*Qy1';
%         Qq2=square(Qq1);
%         P1=zuli(Qq2,S);
%         dp=-Cf*(P1-P)';
%         dp1=max(abs(dp));
%         n2=n2+1;
%         n3=n3+1;
%     end
%     nn2(n1)=n2;   
%     dp0=dp1;
%     Qy=Qy1;
%     n1=n1+1;
    if dp1<dp0
      X0=diag(X1);
      Qy=Qy+(X0*dQ)';
      Qq1=A*Qy';
      Qq2=square(Qq1);
      P1=zuli(Qq2,S);
      dp=-Cf*(P1-P)';
      dp0=dp1;
    end
    dQ=serchJaco(A,S,Cf,Qy,dp);%计算△Q
    n1=n1+1;
    fprintf('Iteration %d', n1); % 打印迭代次数和当前误差
end
%[Q]=flowShare2(Qq,S55,S66,S99,S1010,S1616,S1515,S65,S1414,S654,S1313,S2323,S2222,S2322,S2121,S321,S2424,S2727,S2626,S76,S2525)
Q=flowShare2(Qq1,143151859.5,2394403.038,23512916.74,6095274.041,4351159.541,10784364.49,232889.6,6504043.615,34319.5,1367380.752,3100627.278,4896509.704,4213.57,3971234.857,17343.27,345380552.2,6106344.627,5953431.423,10000,140968672.4);
xlswrite('result1.xls',Q','sheet1','A2');
toc